<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visa Requirements Admin</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CKEditor 5 -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      min-height: 100vh;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body class="d-flex align-items-center justify-content-center p-3">

<div class="container" style="max-width: 800px;">
  <div class="card p-4">
    <h2 class="text-center mb-2">üåç Visa Requirement Admin</h2>
    <p class="text-center text-muted mb-4">Insert visa requirements with full text editor control</p>

    <!-- FORM -->
    <form id="visaForm" novalidate>
      <div class="row g-3">

        <div class="col-md-6">
          <label class="form-label">Country (Origin)</label>
          <input list="countries" id="country" class="form-control" placeholder="e.g. Nepal" required>
          <div class="invalid-feedback">Country is required.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Nationality</label>
          <input list="countries" id="nationality" class="form-control" placeholder="e.g. Nepalese" required>
          <div class="invalid-feedback">Nationality is required.</div>
        </div>

        <div class="col-md-12">
          <label class="form-label">Destination Country</label>
          <input list="countries" id="destination" class="form-control" placeholder="e.g. United States" required>
          <div class="invalid-feedback">Destination country is required.</div>
        </div>

        <div class="col-md-12">
          <label class="form-label">Visa Requirements</label>
          <textarea id="requirementsEditor"></textarea>
          <div class="invalid-feedback d-block" id="editorError" style="display:none;">At least one visa requirement is required.</div>
        </div>

      </div>

      <div class="d-grid mt-4">
        <button type="submit" class="btn btn-success btn-lg">Save Visa Data</button>
      </div>
    </form>
  </div>
</div>

<!-- Country List -->
<datalist id="countries">
  <option value="Nepal">
  <option value="United States">
  <option value="India">
  <option value="Australia">
  <option value="United Kingdom">
  <option value="Canada">
  <option value="Japan">
  <option value="Thailand">
  <option value="Germany">
  <option value="France">
</datalist>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let editorInstance;

ClassicEditor.create(document.querySelector('#requirementsEditor'), {
  toolbar: [
    'heading', '|',
    'bold', 'italic', 'underline', 'link', '|',
    'bulletedList', 'numberedList', '|',
    'blockQuote', 'insertTable', '|',
    'undo', 'redo'
  ]
}).then(editor => {
  editorInstance = editor;
}).catch(error => {
  console.error(error);
});

const form = document.getElementById('visaForm');
const editorError = document.getElementById('editorError');

form.addEventListener('submit', async (e) => {
console.log(form)
  e.preventDefault();
  e.stopPropagation();

  if (!form.checkValidity()) {
    form.classList.add('was-validated');
    return;
  }

  const country = document.getElementById('country').value.trim();
  const nationality = document.getElementById('nationality').value.trim();
  const destination = document.getElementById('destination').value.trim();
  const html = editorInstance.getData().trim();

  if (!html) {
    editorError.style.display = 'block';
    return;
  }

  editorError.style.display = 'none';

  // Convert HTML content into plain text lines
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = html;

  const requirements = Array.from(tempDiv.querySelectorAll('li')).map(li => li.innerText.trim());

  if (requirements.length === 0) {
    const text = tempDiv.innerText
      .split('\n')
      .map(t => t.trim())
      .filter(Boolean);
    requirements.push(...text);
  }

  try {
    const response = await fetch('http://192.168.18.3:5000/api/travel/visa', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        country,
        nationality,
        destination: [
          {
            country: destination,
            details: {
              type: 'list',
              text: requirements
            }
          }
        ]
      })
    });

    if (!response.ok) throw new Error('Request failed');

    alert('Visa data saved successfully ‚úÖ');
    form.reset();
    editorInstance.setData('');
    form.classList.remove('was-validated');

  } catch (error) {
    alert('Error saving visa data ‚ùå');
  }
});
</script>

</body>
</html> 